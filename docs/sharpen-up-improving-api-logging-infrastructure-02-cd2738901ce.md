# 提高:改进 API 日志基础设施(02)

> 原文：<https://medium.datadriveninvestor.com/sharpen-up-improving-api-logging-infrastructure-02-cd2738901ce?source=collection_archive---------6----------------------->

*如何赋予你的日志记录习惯，让日志为你工作，而不是与你作对。*

![](img/429e23647fc35363daca272545c0e89b.png)

Opt for more of these sceneries and less of the pulsing cursor of your favorite text editor.

W 欢迎来到媒体上最不道歉的技术系列的第二部分。这一次不会再有关于写承诺的谎言，我会让其他人代表我去做。

今天我将展示几个想法，它们可以应用到你的日志中，为你周日早上的调试会议节省几个小时。

所有示例都将使用。NET 和 log4net 日志包。一如既往，我将尝试采用适用于任何堆栈的通用方法。

# 动机

如果你曾经离开开发环境哪怕一英寸，你就会知道这是一个脆弱的壮举。这就像在单人模式下练习了几个小时后，终于尝试了多人模式。

你会被抛弃的。

可怕地。

你以为你知道的一切都不再适用了。《浩劫重生》甚至打破了你向所有同龄人吹嘘的那篇文章:“*看，山姆，这就是你怎么做的。这个代码是防弹的。谷歌还需要 20 年才能达到这种编码专业水平。”—* 它不是防弹的。

[](https://www.datadriveninvestor.com/2019/02/25/6-alternatives-to-the-yahoo-finance-api/) [## 雅虎财经 API |数据驱动投资者的 6 种替代方案

### 长期以来，雅虎金融 API 一直是许多数据驱动型投资者的可靠工具。许多人依赖于他们的…

www.datadriveninvestor.com](https://www.datadriveninvestor.com/2019/02/25/6-alternatives-to-the-yahoo-finance-api/) 

作为一名务实的开发人员，您可能已经包含了您最喜欢的日志包，并在您认为必要的地方做了一些陈述。你想，少即是多。如果你足够幸运，其他人已经处理了 web 服务器日志，所以你不必考虑它。

时间戳、严重性和消息。凌晨 3 点宿醉的你还想要什么？

几个月后，你的平台(因为现在所有的东西都是平台)每天会收到大约一百万个请求。

生活是美好的。

云终于说得通了。

您最喜欢的 DevOps 工程师扩展了服务器，现在您有 10 个实例在负载平衡器后面运行。你开始怀疑他是否给过你 PEM 密钥来连接到产品，但你懒得浏览你冗长的松弛对话历史。

在几次报告你的服务(因为现在所有的东西都是服务)出现故障后，你接到经理的电话，说有问题。您可以暂停您的 Haskell 教程并深入研究它。

一小时后，您无法重现该问题。通常，你会宣称这是一次性错误，但这次有点不同，因为你正在处理系统的一个关键部分，你不能冒任何风险。

您呼叫您最喜欢的 DevOps 工程师来为您收集所有日志。你可以听出他声音中的苦涩。他需要一些时间来连接到每个实例并下载所有文件。您最喜欢的 DevOps 工程师在您正在运行的所有实例中向您转储了大约 760MB 的日志文件，并在离开办公室时关上门。

此刻是下午 5 点。

“又来了”——你低声抱怨道。

# 集中您的日志

这一点怎么强调都不为过。事实上，这一点毋庸置疑，可能每个健全的组织都已经有了这样的做法。

随着容器化和微服务架构的出现，你必须将你的日志集中起来，以应对数百万行的胡言乱语。

我认为，即使您不在架构设计的最前沿运行您的服务，您仍然可以通过正确地这样做获得许多好处。

如果没有别的，你正在消除人为错误。你不需要打电话给你最喜欢的 DevOps 工程师，他几乎肯定会花一个小时来尝试获取你一直想要的所有东西。这个过程本身很简单，但是，你可能会打断他的流程，最终减慢他此刻正在做的事情的进度。

**尝试在所有环境中使用相同的日志集中机制。**尽可能争取这种方法，即使这意味着增加开发成本。它可能不总是有回报，但是当它有回报时，你会很高兴这个问题在它上线之前就被发现了。

老实说，通常没有人会让 SSH 跟踪打开的 worker 实例上的日志文件。能够不时地在暂存环境中滚动查看同一个实例的日志摘要，可能会让您对您构建的东西随着时间的推移是如何执行的有价值的了解。

也就是说，如果团队忽视它或者认为它会给他们带来负担，那么它就没有任何价值。尝试沟通这一点，理想的结果是共享整个事情的所有权。这意味着前端工程师有权发现后端的异常，反之亦然。

如果您想拥有一流的软件，您需要有一流的监控，这适用于您的所有 7 个环境。

有许多选项可供选择，最著名的是面向开源爱好者的 [ELK stack](https://www.elastic.co/what-is/elk-stack) 和面向那些感谢 GitHub 问题评论区客户支持的 [DataDog](https://www.datadoghq.com/) 。

由于日志收集和组织都在一个地方，您可以使用您选择的浏览器开始挖掘这些数百万的日志行，而不用折磨您最喜欢的 DevOps 工程师。从现在开始，你们两个甚至可以在下班后喝啤酒。

# 添加更多元信息

在你习惯了不同于文本编辑器的用户界面之后，阅读日志应该就像蛋糕一样容易了。

直到你需要大海捞针，而你把眼镜落在家里。

只有时间戳、严重性和消息只能让你到此为止。

幸运的是，您的日志收集系统可能会牵着您的手，为您提供各种主机元信息。这些信息各不相同，但您可以预期有一个源筛选器(包括应用程序和主机)、可用性区域等。

如果你正在构建一个多线程的解决方案，事情会变得有点混乱。事情并不像开发应用程序时那样简单。每天有数百万个请求点击你的服务，记得吗？再加上跨所有正在运行的实例异步处理多个请求的能力，您将享受到真正的乐趣。

重建单个请求的生命周期的努力是荒谬的。通常要花 5 分多钟才能把所有的碎片缝合在一起。这使得假设检验非常乏味，你会倾向于完全避免它。

我建议您为每个日志行添加一个与特定请求相关的关联 id。现在您将能够知道哪一行属于哪一个请求。

使用 log4net，您可以通过一个非常简单的实现将属性添加到上下文中:

If GUID makes you uncomfortable, you can always opt-in for any other unique identifier.

并将该属性添加到转换模式中:

You can read more about conversion layouts [here](https://logging.apache.org/log4net/log4net-1.2.13/release/sdk/log4net.Layout.PatternLayout.html).

现在，请求生命周期重建要简单得多，您可以在几秒钟内过滤出特定请求的日志。

我建议监控的另一件事是当前的请求主体。换句话说，谁在使用我的服务。你可能会说，在每一行都包含这些信息是多余的，而不是在开始时只包含一次，我同意这一点。我喜欢在所有行上都显示这些信息，以便在没有应用过滤器的情况下快速浏览日志文件。

同样，您[用一个非常简单的实现向上下文](https://logging.apache.org/log4net/release/manual/contexts.html)添加了一个属性:

Identity might be provided by the external dependency as well.

使最终的转换模式看起来像这样:

Final conversion pattern.

如果你使用电子邮件作为身份识别的手段，你应该考虑审查它，特别是如果你办公室里有一台电视，可能会显示敏感的客户信息。

# 从… 清理无用之物

当您第一次编写新特性的代码时，您很可能无法预测它在生产环境中的所有细微差别。

你需要预见到问题，并确保你总是能够重建客户想要做的事情。为了做到这一点，你有时会发现自己被不必要的信息所包围。

假设您有一个货币转换器服务，每次转换一些金额时，它都有三行日志记录。如果您需要转换 100 笔金额以将其返回给客户端，那么对于单个请求，这将产生至少 300 个日志行。

虽然在某些情况下您可能会发现这是合理的，但大多数时候这只是普通的噪音。如果经常使用特定的货币转换服务，情况会变得更加严重。

如果您使用付费日志收集提供商，如 DataDog，您也将获得金钱上的好处，因为您是在为每月生成的行数付费。

另一个改进是严格的异常日志记录。如果有细粒度的客户端异常，并且可以根据请求信息和客户端异常确定发生了什么，就可以安全地删除堆栈跟踪。

一旦你很好地掌握了框架/语言，堆栈跟踪真的很有用，但是，我不认为它们为客户端异常增加了任何价值。你是在一个特定的背景下抛出它们的人，你应该能够知道为什么和在哪里发生的。

对于不确定如何发生的未处理的服务器端异常，只记录堆栈跟踪可能更好。这些可能很难调试，每一条信息都可以派上用场。

另一件要考虑的事情是禁用特定于框架或特定于包的日志记录。这些信息在项目的开始阶段可能是有价值的，因为那时平台还不太成熟，还比较脆弱。过一会儿就变成噪音了。

为了更好地描绘这幅画面，让我们考虑一个任意的企业作业调度器。您确定需要每 100 毫秒查看一次为触发器生成的 SQL 语句吗？如果这个问题的答案除了*【绝对】，*之外，你应该考虑关掉它。

通过应用这些步骤，我一个月可以轻松地删除大约 1000 万行日志，总数达到 500 万行。

# 与你的同事交谈

你需要了解你的观众。你可能认为你是观众，但很少是这样的。当然，你的产品负责人不会查看日志，但是你的 QA 同事可能会。

你可能会休息一天，你的服务可能会有问题。如果你的同事不需要你的帮助就能调查这个问题，那将会非常有帮助。

询问您的同事，在开发任何功能时，他们认为在日志中查看哪些内容可能有用。起初，您可能得不到任何有用的信息，但是，让人们参与到这个过程中会进一步加强日志记录基础结构的共享所有权。

在生产中出现下一个问题后，做一个类似事后分析的小事件。期望我们在开发/测试阶段就能预见所有的问题是天真的。因此，您需要有强大的机制来解决问题，并在出现这种问题时创造异常的响应时间。您不仅应该确保这种问题不会再次发生，而且还应该考虑到您的预防机制仍然很脆弱。

你会错，你会犯错误。

确保你能从中恢复过来。

不要只是为了让你的头露出水面，要追求时尚！

几个周期后，人们将更好地预测什么信息在未来可能是有价值的，你将能够在你的日志中有非常用户友好的有价值的信息。

# 重复

如果你一开始失败了，不要担心。

尝试采用精益方法，并尝试找出适合您的项目的方法。要明白这并不总能给你的项目带来最大的价值。

有些人不想被牵扯进来。没关系，你不能强迫任何人做任何事(即使你有足够的权力这样做，你也不应该这样做)。

人们喜欢被倾听。用那个！

与你可能相信的相反，倾听他人会有所启发，你的胃痉挛可能会消失。

过一会儿，您将体验到您的团队的日志风格的自然开端。我不认为开发人员应该被关于日志记录习惯的“字面”规则所累。

在越来越多的敏捷社区中(我敢说是部落)，团队是项目中任何事情的唯一来源。

通过将这些规则应用到你的案例中，你可以成为项目中一个经常被忽视的方面的催化剂。

如果执行得当，整个团队都会强化自己的领域知识，培养以后形成因果联系的能力。

这是日志主题的一种适度的技术方法，旨在提高意识并给出一些易于应用的实用想法。

如果有一件事你应该从中吸取教训，那就是你应该思考日志如何适应你的项目结构。不管你是否使用这里展示的任何想法都没关系。日志记录不应该是事后才想到的，应该不断改进这个过程。

人类在无限混乱的宇宙中创造秩序，而开发者在无限混乱的软件中创造秩序。

点击这里查看 SharpenUp 系列[的前一篇文章。](https://medium.com/@kristicevic.antonio/sharpen-up-generic-object-builder-reflection-and-dynamic-objects-01-pilot-3a2f864b16e2)